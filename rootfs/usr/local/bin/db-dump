#!/usr/bin/env bash

set -e
set -o pipefail

[[ -z $TRACE ]] || set -x

cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
source "./common.include"

# Check environment
[[ -z $BUCKET_NAME ]] && die "BUCKET_NAME must be set"
[[ -z $BUCKET_CREDENTIALS ]] && die "BUCKET_CREDENTIALS must be set"
[[ -z $DB_HOST ]] && die "DB_HOST must be set"
[[ -z $DB_NAME ]] && die "DB_NAME must be set"
[[ -z $DB_PASSWORD ]] && die "DB_PASSWORD must be set"
[[ -z $DB_USER ]] && die "DB_USER must be set"

function dump() {
  mysqldump --host="${DB_HOST}" \
            --user="${DB_USER}" \
            --password="${DB_PASSWORD}" \
            --single-transaction \
            --add-drop-table \
            "${DB_NAME}" "$@" > /data/"${DB_NAME}".sql
}

if [[ -z $TABLE_FILE ]]; then
  echo "No table file specified. Dumping all tables."
  dump
else
  echo "Table file specified. Dumping selected tables."
  readarray -t tables < "$TABLE_FILE"
  dump --tables "${tables[@]}"
fi
